#!/usr/bin/env coffee

http = require 'http'
sockjs = require 'sockjs'
optimist = require 'optimist'
forever = require 'forever'

argv = optimist
  .options('p', alias: 'port', default: 8100)
  .argv

clients = {}
realms = {}

process.on 'exit', ->
  forever.stopAll()

# Default realm.
realms.default =
  address: 'localhost:8200'
  child: forever.start "#{ __dirname }/krag-realm",
    command: "#{ __dirname }/../node_modules/coffee-script/bin/coffee"
    fifo: true
    verbose: true

socket = sockjs.createServer()
socket.on 'connection', (conn) ->
  console.log "Client #{ conn.id } connected"
  clients[conn.id] = conn
  conn.on 'close', ->
    console.log "Client #{ conn.id } disconnected"
    delete clients[conn.id]

server = http.createServer()
socket.installHandlers server, prefix: '/socket'
server.listen argv.port, '0.0.0.0'
console.log "Realm Admin listening on port #{ argv.port }"
